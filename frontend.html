<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MVZx — Mobile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <style>
    :root { --btn:#0b74de; --bg:#f7fafc; --card:#ffffff; --w:360px; }
    html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Helvetica,Arial,sans-serif}
    .screen{width:100%;max-width:var(--w);margin:0 auto;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:12px;box-sizing:border-box}
    header{width:100%;text-align:center;margin-top:8px}
    h1{font-size:20px;margin:4px 0}
    .buttons{width:100%;display:flex;flex-direction:column;gap:10px;margin-top:18px}
    .btn{background:var(--btn);color:#fff;padding:14px;border-radius:10px;border:none;font-size:16px;width:100%}
    .smallbtn{background:#ddd;color:#111;padding:10px;border-radius:8px;border:none;font-size:14px}
    .card{width:100%;background:var(--card);border-radius:12px;padding:12px;margin-top:14px;box-shadow:0 6px 10px rgba(0,0,0,0.06)}
    .hidden{display:none}
    input,select{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #e2e8f0}
    pre{white-space:pre-wrap;word-break:break-word}
    footer{font-size:12px;color:#666;margin-top:auto;padding-bottom:10px}
    /* ensure no scroll on initial landing; sections can scroll if needed */
    .section-scroll{max-height:68vh;overflow:auto;padding-right:6px}
  </style>
</head>
<body>
  <div class="screen" id="app">
    <header><h1>MVZx</h1><div style="font-size:12px;color:#555">Buy MVZx • Matrix • Stake • Withdraw</div></header>

    <!-- Landing buttons — no scroll here -->
    <div id="landing" class="buttons">
      <button class="btn" onclick="show('signup')">Signup</button>
      <button class="btn" onclick="show('wallet')">Wallet</button>
      <button class="btn" onclick="show('buy')">Buy Tokens</button>
      <button class="btn" onclick="show('matrix')">Matrix</button>
      <button class="btn" onclick="show('stake')">Staking</button>
      <button class="btn" onclick="show('withdraw')">Withdraw</button>
      <button class="smallbtn" onclick="show('admin')">Admin</button>
    </div>

    <!-- pages (hidden by default) -->
    <div id="pages" class="card hidden">

      <!-- Signup -->
      <div id="signup" class="section section-scroll hidden">
        <h3>Signup (get 0.5 MVZx)</h3>
        <input id="su_phone" placeholder="Phone (e.g. 080...)" />
        <input id="su_pin" placeholder="4-digit PIN" maxlength="4" />
        <input id="su_ref" placeholder="Referrer ID (optional)" />
        <button class="btn" onclick="signup()">Create Account</button>
        <button class="smallbtn" onclick="back()">Back</button>
        <pre id="su_msg"></pre>
      </div>

      <!-- Wallet -->
      <div id="wallet" class="section section-scroll hidden">
        <h3>Your Wallet</h3>
        <pre id="wallet_info">Not loaded</pre>
        <button class="smallbtn" onclick="refreshWallet()">Refresh Wallet</button>
        <button class="smallbtn" onclick="back()">Back</button>
      </div>

      <!-- Buy -->
      <div id="buy" class="section section-scroll hidden">
        <h3>Buy Tokens</h3>
        <input id="buy_amount" placeholder="Amount in NGN (min 200)" value="2000" />
        <select id="buy_method">
          <option value="FLW">Pay with Naira (Flutterwave)</option>
          <option value="USDT">Pay with USDT (BEP20) - Send to company wallet</option>
          <option value="MANUAL">Manual Bank Deposit</option>
        </select>
        <div style="margin-top:8px;font-size:13px;color:#333">
          Company Wallet: <span id="company_wallet_display" style="font-weight:600"></span>
        </div>
        <button class="btn" onclick="buyTokens()">Proceed</button>
        <button class="smallbtn" onclick="back()">Back</button>
        <pre id="buy_msg"></pre>
      </div>

      <!-- Matrix -->
      <div id="matrix" class="section section-scroll hidden">
        <h3>Matrix Status</h3>
        <pre id="matrix_info">No data</pre>
        <button class="smallbtn" onclick="back()">Back</button>
      </div>

      <!-- Stake -->
      <div id="stake" class="section section-scroll hidden">
        <h3>Stake Tokens (100% reward in 150 days)</h3>
        <input id="stake_amount" placeholder="Amount of MVZx to stake" />
        <button class="btn" onclick="stakeTokens()">Stake</button>
        <button class="smallbtn" onclick="claimStakes()">Claim Matured Stakes</button>
        <button class="smallbtn" onclick="back()">Back</button>
        <pre id="stake_msg"></pre>
      </div>

      <!-- Withdraw -->
      <div id="withdraw" class="section section-scroll hidden">
        <h3>Withdraw</h3>
        <input id="wd_amount" placeholder="Amount of MVZx to withdraw" />
        <select id="wd_method"><option>USDT</option><option>BANK</option></select>
        <input id="wd_details" placeholder="USDT address or Bank details" />
        <button class="btn" onclick="createWithdraw()">Create Withdraw Request</button>
        <button class="smallbtn" onclick="back()">Back</button>
        <pre id="withdraw_msg"></pre>
      </div>

      <!-- Admin (protected by admin token input) -->
      <div id="admin" class="section section-scroll hidden">
        <h3>Admin Panel</h3>
        <input id="admin_token" placeholder="Admin Secret (simple gate)" />
        <button class="smallbtn" onclick="listMatrixPending()">List Matrix Pending</button>
        <div id="admin_matrix_list"></div>
        <button class="smallbtn" onclick="listWithdrawals()">List Withdrawals</button>
        <div id="admin_withdrawals"></div>
        <button class="smallbtn" onclick="back()">Back</button>
        <pre id="admin_msg"></pre>
      </div>

    </div>

    <footer>MVZx • Keep your PIN private</footer>
  </div>

<script>
  // ---------- CONFIG ----------
  const API_BASE = "https://YOUR-BACKEND-URL.onrender.com/api"; // <<-- set backend URL here
  const COMPANY_WALLET = (function(){ return ("{{COMPANY_WALLET}}" === "{{COMPANY_WALLET}}") ? "" : ""; })(); // not used; backend shows actual
  // ---------- STATE ----------
  let token = localStorage.getItem("mvzx_token") || null;
  let userId = localStorage.getItem("mvzx_userId") || null;

  // set company wallet display using backend call
  (async function setCompanyWallet() {
    try {
      // we cannot fetch env from backend directly; display blank instruction
      document.getElementById("company_wallet_display").innerText = "Check backend env (COMPANY_WALLET)";
    } catch {}
  })();

  // ---------- UI helpers ----------
  function show(page) {
    document.getElementById("landing").style.display = "none";
    document.getElementById("pages").classList.remove("hidden");
    const sections = document.querySelectorAll("#pages .section");
    sections.forEach(s => s.classList.add("hidden"));
    const el = document.getElementById(page);
    if (el) el.classList.remove("hidden");
  }
  function back() {
    document.getElementById("pages").classList.add("hidden");
    document.getElementById("landing").style.display = "flex";
    // clear messages
    ["su_msg","buy_msg","stake_msg","withdraw_msg","admin_msg"].forEach(id => { const e=document.getElementById(id); if(e) e.innerText=""; });
  }
  function showMsg(id, text) { const e=document.getElementById(id); if(e) e.innerText = typeof text === "string" ? text : JSON.stringify(text,null,2); }

  // ---------- API helpers ----------
  async function api(path, method="GET", body=null) {
    const headers = {"Content-Type":"application/json"};
    if (token) headers["Authorization"] = "Bearer " + token;
    const opts = { method, headers };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(API_BASE + path, opts);
    const json = await res.json().catch(()=>({}));
    if (!res.ok) throw json;
    return json;
  }

  // ---------- actions ----------
  async function signup() {
    const phone = document.getElementById("su_phone").value.trim();
    const pin = document.getElementById("su_pin").value.trim();
    const ref = document.getElementById("su_ref").value.trim() || null;
    if (!phone || !/^\d{4}$/.test(pin)) return showMsg("su_msg","Enter phone and 4-digit PIN");
    try {
      const r = await fetch(API_BASE + "/signup", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ phone, pin, referrerId: ref }) });
      const j = await r.json();
      if (j.token) {
        token = j.token; userId = j.userId;
        localStorage.setItem("mvzx_token", token);
        localStorage.setItem("mvzx_userId", userId);
        showMsg("su_msg", "Signup successful. Wallet: " + j.walletAddress);
      } else {
        showMsg("su_msg", JSON.stringify(j));
      }
    } catch (e) {
      showMsg("su_msg", "Signup failed: " + (e.error || JSON.stringify(e)));
    }
  }

  async function refreshWallet() {
    try {
      if (!token) return alert("Login/signup first");
      const j = await api("/wallet");
      document.getElementById("wallet_info").innerText = JSON.stringify(j.wallet,null,2);
    } catch (e) {
      document.getElementById("wallet_info").innerText = "Error: " + JSON.stringify(e);
    }
  }

  async function buyTokens() {
    try {
      if (!token) return alert("Login/signup first");
      const amount = Number(document.getElementById("buy_amount").value);
      const method = document.getElementById("buy_method").value;
      if (!amount || amount < 200) return showMsg("buy_msg", "Minimum NGN 200");
      if (method === "USDT") {
        // instruct user to send USDT to company wallet
        showMsg("buy_msg", "Send USDT (BEP20) to the company wallet address on BSC. After confirmation tokens will be credited automatically.");
        return;
      } else if (method === "MANUAL") {
        const j = await api("/purchase/manual", "POST", { amountNGN: amount });
        showMsg("buy_msg", "Manual deposit record created. PurchaseId: " + j.purchaseId + ". Wait for admin approval.");
        return;
      } else if (method === "FLW") {
        const j = await api("/purchase/flutterwave/init", "POST", { amountNGN: amount });
        if (j.checkoutUrl) {
          // open flutterwave link in new tab (or redirect)
          window.open(j.checkoutUrl, "_blank");
          showMsg("buy_msg", "Opened Flutterwave checkout. Complete the payment and webhook will credit tokens.");
        } else {
          showMsg("buy_msg", "Payment initiated: " + JSON.stringify(j));
        }
      }
    } catch (e) {
      showMsg("buy_msg", "Error: " + JSON.stringify(e));
    }
  }

  async function refreshMatrix() {
    try {
      if (!token) return alert("Login/signup first");
      const j = await api("/matrix");
      document.getElementById("matrix_info").innerText = JSON.stringify(j.matrix, null, 2);
    } catch (e) {
      document.getElementById("matrix_info").innerText = "Error: " + JSON.stringify(e);
    }
  }

  async function stakeTokens() {
    try {
      if (!token) return alert("Login/signup first");
      const amount = Number(document.getElementById("stake_amount").value);
      if (!amount || amount <= 0) return showMsg("stake_msg","invalid amount");
      const j = await api("/stake","POST",{ amount });
      showMsg("stake_msg", "Staked. Maturity: " + new Date(j.maturity).toLocaleString());
    } catch (e) {
      showMsg("stake_msg", "Error: " + JSON.stringify(e));
    }
  }

  async function claimStakes() {
    try {
      const j = await api("/stake/claim","POST");
      showMsg("stake_msg", "Claim result: " + JSON.stringify(j));
    } catch (e) {
      showMsg("stake_msg", "Error: " + JSON.stringify(e));
    }
  }

  async function createWithdraw() {
    try {
      if (!token) return alert("Login/signup first");
      const amount = Number(document.getElementById("wd_amount").value);
      const method = document.getElementById("wd_method").value;
      const details = document.getElementById("wd_details").value;
      const j = await api("/withdraw","POST",{ amount, method, details });
      showMsg("withdraw_msg","Withdraw created. Wait for admin processing.");
    } catch (e) {
      showMsg("withdraw_msg","Error: " + JSON.stringify(e));
    }
  }

  // Admin functions (simple client-side gate using admin token string — for production use proper auth)
  async function listMatrixPending() {
    try {
      const adminToken = document.getElementById("admin_token").value || "";
      if (!adminToken) return document.getElementById("admin_msg").innerText = "Enter admin secret in box above";
      // The backend admin endpoints are not protected by admin token in this single-file; you'd typically protect with JWT+role.
      // We'll call the admin endpoints - they are public in this demo but should be protected on your render.
      const j = await fetch(API_BASE + "/admin/matrix/pending");
      const data = await j.json();
      const container = document.getElementById("admin_matrix_list");
      container.innerHTML = "";
      if (data.rows && data.rows.length) {
        data.rows.forEach(r => {
          const div = document.createElement("div");
          div.style.borderTop = "1px solid #eee";
          div.style.padding = "8px";
          div.innerHTML = `<b>Matrix #${r.id}</b> user:${r.user_id} pending:${r.pending_payout} <button onclick="adminPayout(${r.id})">Payout</button>`;
          container.appendChild(div);
        });
      } else container.innerText = "No pending";
    } catch (e) {
      document.getElementById("admin_msg").innerText = "Error: " + JSON.stringify(e);
    }
  }
  async function adminPayout(matrixId) {
    try {
      const r = await fetch(API_BASE + "/admin/matrix/payout/" + matrixId, { method:"POST" });
      const j = await r.json();
      alert("Payout result: " + JSON.stringify(j));
      listMatrixPending();
    } catch (e) { alert("err " + JSON.stringify(e)); }
  }

  async function listWithdrawals() {
    try {
      const r = await fetch(API_BASE + "/admin/withdrawals");
      const j = await r.json();
      const c = document.getElementById("admin_withdrawals");
      c.innerHTML = "";
      j.rows.forEach(row => {
        const div = document.createElement("div");
        div.style.borderTop = "1px solid #eee";
        div.style.padding = "8px";
        div.innerHTML = `<b>WD #${row.id}</b> user:${row.user_id} amount:${row.amount} method:${row.method} status:${row.status} <button onclick="adminExec(${row.id})">Exec</button>`;
        c.appendChild(div);
      });
    } catch (e) {
      document.getElementById("admin_msg").innerText = "Error: " + JSON.stringify(e);
    }
  }
  async function adminExec(id) {
    try {
      const r = await fetch(API_BASE + "/admin/withdrawals/execute/" + id, { method:"POST" });
      const j = await r.json();
      alert("exec result: " + JSON.stringify(j));
      listWithdrawals();
    } catch (e) { alert("exec err " + JSON.stringify(e)); }
  }

  // quick refreshes
  async function buyHook() { await refreshWallet(); refreshMatrix(); }
  async function refreshMatrixIfVisible() { if (!document.getElementById("pages").classList.contains("hidden")) refreshMatrix(); }

  // load last wallet on start
  (function init(){
    if (token) {
      refreshWallet();
      refreshMatrix();
    }
  })();
</script>
</body>
</html>
